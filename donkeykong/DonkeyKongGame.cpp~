//
//  DonkeyKongGame.cpp
//  donkeykong
//
//  Created by Jacob Gavin on 3/19/14.
//  Copyright (c) 2014 Jacob Gavin. All rights reserved.
//

#include <SDL/SDL.h>
#include <iostream>
#include "SDL/SDL.h"
#include <string>
#include "DonkeyKongGame.h"
#include "Object.h"
#include "Mario.h"
#include "Peach.h"
#include "DonkeyKong.h"
#include "Barrel.h"
#include "Oil.h"
#include "Fireball.h"
#include "math.h"
#include <stdlib.h>
#include <time.h>
#include <vector>

//#include "SDL/SDL_mixer.h"
//#include "SDL_image/SDL_image.h"
//include "SDL_ttf/SDL_ttf.h"

using namespace std;


SDL_Event event;
//The music that will be played
//Mix_Music *music = NULL;

//Constructor for DonkeyKongGame, initializes SDL, creates screen, and loads background
DonkeyKongGame::DonkeyKongGame ()
{
    SDL_Init (SDL_INIT_EVERYTHING);
    // SDL_Color textColor = { 255, 255, 255 }; // it's white for now, color of text
    screen = SDL_SetVideoMode (550, 471, 32, SDL_SWSURFACE);
    background = SDL_LoadBMP ("DonkeyKongBackground.bmp");
    
    // TTF_Font *font;
    // font = TTF_OpenFont( "kongtext.ttf", 36 ); //size 12 font
    // message = TTF_RenderText_Solid( font, "Current Score:", textColor );
    mario.initializeFloors ();
    //Barrel barrel;
    barrels.push_back(Barrel());
    
    level = 1;
}


void DonkeyKongGame::Music ()
{
    
    // Mix_OpenAudio( 22050, MIX_DEFAULT_FORMAT, 2, 4096 );
    //  music = Mix_LoadMUS( "intro.wav" );
    //  Mix_PlayMusic(music, -1);
}

//Display function which puts background and all objects on screen
void DonkeyKongGame::Display ()
{
    int i;
    
    SDL_FillRect (screen, &screen->clip_rect,
                  SDL_MapRGB (screen->format, 0xFF, 0xFF, 0xFF));
    
    //Apply image to screen
    SDL_BlitSurface (background, NULL, screen, NULL);
    
    if (mario.getclimbing () == 0)
    {
        mario.display (screen, mario.getMarioSurface (), mario.getxpos (),
                       mario.getypos (),
                       mario.getspritesheetx () +
                       mario.getcurrentframe () * mario.getwidth (),
                       mario.getspritesheety (), mario.getwidth (),
                       mario.getheight ());
    }
    if (mario.getclimbing () == 1)
    {
        mario.climbingdisplay (screen, mario.getMarioSurface (),
                               mario.getxpos (), mario.getypos (),
                               mario.getspritesheetx () +
                               mario.getcurrentframe () * mario.getwidth () * 2,
                               mario.getspritesheety (), mario.getwidth (),
                               mario.getheight ());
    }
    
    peach.display (screen, peach.getMarioSurface (), peach.getxpos (),
                   peach.getypos (),
                   peach.getspritesheetx () +
                   peach.getcurrentframe () * peach.getwidth (),
                   peach.getspritesheety (), peach.getwidth (),
                   peach.getheight ());

    oil.display (screen, oil.getMarioSurface (), oil.getxpos (),
                   oil.getypos (),
                   oil.getspritesheetx () +
                   oil.getcurrentframe () * oil.getwidth (),
                   oil.getspritesheety (), oil.getwidth (),
                   oil.getheight ());
    
    donkeykong.display (screen, donkeykong.getMarioSurface (),
                        donkeykong.getxpos (), donkeykong.getypos (),
                        donkeykong.getspritesheetx () +
                        donkeykong.getcurrentframe () * donkeykong.getwidth (),
                        donkeykong.getspritesheety (), donkeykong.getwidth (),
                        donkeykong.getheight ());
    
    if(mario.hadHammer == 0) hammer.display (screen, hammer.getMarioSurface (),
                        hammer.getxpos (), hammer.getypos (),
                        hammer.getspritesheetx () +
                        hammer.getcurrentframe () * hammer.getwidth (),
                        hammer.getspritesheety (), hammer.getwidth (),
                        hammer.getheight ());
    
    for(i = 0; i < barrels.size(); i++){
       if(barrels[i].alive == 1) barrels[i].display(screen, barrels[i].getMarioSurface(), barrels[i].getxpos(), barrels[i].getypos(), barrels[i].getspritesheetx() + barrels[i].getcurrentframe()*barrels[i].getwidth(), barrels[i].getspritesheety(), barrels[i].getwidth(), barrels[i].getheight());
    }

    if(fireball.alive == 1) fireball.display (screen, fireball.getMarioSurface (),
                        fireball.getxpos (), fireball.getypos (),
                        fireball.getspritesheetx () +
                        fireball.getcurrentframe () * fireball.getwidth (),
                        fireball.getspritesheety (), fireball.getwidth (),
                        fireball.getheight ());
	
    
    
    SDL_Flip (screen);
    
}

//Function to clean up game when over
void DonkeyKongGame::cleanUp ()
{
    
    //Free the loaded image
    //SDL_FreeSurface( screen );
    SDL_FreeSurface (background);
    //SDL_FreeSurface (message);
    mario.cleanUp ();
    // Mix_FreeMusic( music );
    
    //Quit SDL Mixer
    //  Mix_CloseAudio();
    //Quit SDL
    SDL_Quit ();
}

//Function to create gameplay
void DonkeyKongGame::playDonkeyKong ()
{
    bool quit = false;
    int counter = 0;
    int i;
    int oldState;
    int winner;
    Display ();
    Music ();
    srand (time(NULL));
    while (quit == false){
        winner = 0;
        initializeLevel();
        while(winner == 0 && quit == false)
        {
        //cout << "onFloor = " << mario.onFloor << endl;
        if (mario.getoldtime () + mario.getframerate () < SDL_GetTicks ())
        {
            oldState = mario.currentState;
            mario.determineAnimation();
            if(oldState == mario.currentState){
                mario.updateAnimation ();
            }
            else{
                mario.setAnimation();
            }
        }
	if (oil.getoldtime () + oil.getframerate () < SDL_GetTicks ())
        {
		oil.updateAnimation();
	}
        if ((peach.getoldtime () + peach.getframerate () < SDL_GetTicks ())
            && (counter % 5) == 0)
        {
            peach.updateAnimation ();
            if (counter % 30 == 0 && peach.currentState == 1)
            {
                peach.currentState = 2;
                peach.setAnimation ();
            }
            else if (counter % 30 == 0 && peach.currentState == 2)
            {
                peach.currentState = 1;
                peach.setAnimation ();
            }
        }
        if ((donkeykong.currentState == 3 && donkeykong.currentFrame == 2) || (donkeykong.currentState == 2 && donkeykong.currentFrame == 0))
        {
            if (rand() % 10 + 1 >= 3 && donkeykong.currentState != 3 && counter % 150 == 0)
            {
                donkeykong.currentState = 3;
                donkeykong.setAnimation();
            }
            else if (donkeykong.currentState != 2 && counter % 150 == 0)
            {
                donkeykong.currentState = 2;
                donkeykong.setAnimation();
            }
        }
        if (counter % 150 == 0 && donkeykong.currentState == 2)
        {
            if (donkeykong.currentFrame == 0)
            {
                donkeykong.updateAnimation ();
                donkeykong.updateAnimation ();
                donkeykong.updateAnimation ();
            }
            else
            {
                donkeykong.updateAnimation ();
            }
            
        }
        if (counter % 150 == 0 && donkeykong.currentState == 3)
        {
            if (donkeykong.currentFrame == 2)
            {
                donkeykong.updateAnimation ();
                donkeykong.updateAnimation ();
                donkeykong.updateAnimation ();
                donkeykong.updateAnimation ();
            }
            else if (donkeykong.currentFrame == 0)
            {
                donkeykong.updateAnimation ();
                donkeykong.updateAnimation ();
                donkeykong.updateAnimation ();
            }
            else if (donkeykong.currentFrame == 3)
            {
                Barrel barrel;
                barrels.push_back(barrel);
                for(i = 0; i < barrels.size(); i++){
                    barrels[i].currentState = 1;
                    barrels[i].currentFrame = 2;
                    barrels[i].updateAnimation();
                    barrels[i].updateAnimation();
                }
                
                if (rand() % 10 + 1 >= 4 || mario.getypos() <= 250)
                {
                    donkeykong.updateAnimation ();
                    donkeykong.updateAnimation ();
                }
                else
                {
                    donkeykong.updateAnimation ();
                    donkeykong.updateAnimation ();
                    donkeykong.updateAnimation ();
                    donkeykong.updateAnimation ();
                    donkeykong.updateAnimation ();
                }
            }
            else
            {
                donkeykong.updateAnimation ();
                donkeykong.updateAnimation ();
                donkeykong.updateAnimation ();
            }
        }
        while (SDL_PollEvent (&event))
        {
            mario.checkOnFloor (0);
            if (mario.getoldtime () + mario.getframerate () < SDL_GetTicks ())
            {
                mario.updateAnimation ();
            }
            //Handle events for Mario
            mario.handle_input (event);
            //If the user has Xed out the window
            if (event.type == SDL_QUIT)
            {
                //Quit the program
                quit = true;
            }
            mario.updateAnimation ();
        }
        counter += 1;
        for(i = 0; i < barrels.size(); i++){
           barrels[i].roll();
        }
        mario.move ();
        mario.checkOnFloor (0);
        for(i = 0; i < barrels.size(); i++){
            barrels[i].checkOnFloor(1);
        }
        if(mario.hasHammer == 0){
          if(mario.checkOnLadder(mario.direction) == 1){
              mario.onLadder = 1;
          }
          else if(mario.checkOnLadder(mario.direction) == 2){
              mario.onLadder = 2;
              mario.vy = 0;
          }
          else{
              mario.onLadder = 0;
          }
        }
        if(checkForCollisions()){
           // cout << "Died" << endl;
            mario.alive = 0;
            mario.climbing = 0;
            mario.onLadder = 0;
            if(mario.rdirection == 0) mario.vx = 2;
            if(mario.rdirection == 1) mario.vx = -2;
            mario.vy = -6;
            mario.currentState = 14;
            mario.setAnimation();
        }
        if(mario.checkForHammer()){
            mario.hasHammer = 1;
            mario.hammerStartTime = SDL_GetTicks();
           // cout << "Got hammer" << endl;
        }
        if((SDL_GetTicks() - mario.hammerStartTime > 10000)&&(mario.hasHammer)){
            mario.hasHammer =  0;
            mario.currentState = 1;
            mario.setAnimation();
        }
            setBarrelSpeedBoost();
        Display ();
        winner = checkForWinner();
    }
    }
    SDL_Quit ();
}

int DonkeyKongGame::checkForCollisions(){
    int i;
    int barrelXmin;
    int barrelXmax;
    int barrelYcenter;
    int hammerXmin;
    int hammerXmax;
    int hammerYmin;
    int hammerYmax;
    if(mario.rdirection == 0){
        hammerXmin = mario.xpos;
        hammerXmax = mario.xpos + 10;
    }
    if(mario.rdirection == 1){
        hammerXmin = mario.xpos + 21;
        hammerXmax = mario.xpos + 31;
    }
    hammerYmin = mario.ypos + 18;
    hammerYmax = mario.ypos + 30;
    
    if(mario.hasHammer){
      for(i = 0; i < barrels.size(); i++){
          barrelXmin = barrels[i].xpos;
          barrelXmax = barrels[i].xpos + barrels[i].width;
          barrelYcenter = barrels[i].ypos + barrels[i].height/2;
          if(((barrelXmax >= hammerXmin)&&(barrelXmin <= hammerXmax))&&((barrelYcenter >= hammerYmin)&&(barrelYcenter <= hammerYmax))){
              barrels[i].alive = 0;
            //  cout << "barrelYcenter = " << barrelYcenter << endl;
            //  cout << "hamerYmin = " << hammerYmin << endl;
            //  cout << "hammerYmax = " << hammerYmax << endl;
          }
      }
    }
    
    
    int barrelxcenter;
    int barrelycenter;
    int marioxcenter = mario.xpos + mario.width/2;
    int marioycenter = mario.ypos + mario.height/2;
    int barrelradius = 6;
    int marioradius = 8;
    int mindistance;
    double distance;
    
    for(i = 0; i < barrels.size(); i++){
        barrelxcenter = barrels[i].xpos + barrels[i].width/2;
        barrelycenter = barrels[i].ypos + barrels[i].height/2;
        mindistance = marioradius + barrelradius;
        distance = sqrt(pow(marioxcenter-barrelxcenter,2)+pow(marioycenter-barrelycenter,2));
        //cout << "Barrel " << i << " distance = " << distance << endl;
        if((distance < mindistance)&&(barrels[i].alive)) return 1;
    }

    int oilxcenter = oil.xpos + oil.width/2;
    int oilycenter = oil.ypos + oil.height/2;
    barrelradius = 6;
    int oilradius = 8;

    for(i = 0; i < barrels.size(); i++){
        barrelxcenter = barrels[i].xpos + barrels[i].width/2;
        barrelycenter = barrels[i].ypos + barrels[i].height/2;
        mindistance = oilradius + barrelradius;
        distance = sqrt(pow(oilxcenter-oilxcenter,2)+pow(oilycenter-oilycenter,2));
        //cout << "Barrel " << i << " distance = " << distance << endl;
        if((distance < mindistance)&&(barrels[i].alive)){
		fireball.alive=1;
	}
    }
    
    
    return 0;
}

int DonkeyKongGame::checkForWinner(){
    if(mario.ypos + mario.height <= 123){
        level++;
        SDL_Delay(3000);
        return 1;
    }
    else{
        return 0;
    }
}

void DonkeyKongGame::initializeLevel(){
    //Initialize Mario
    mario.xpos = 130;
    mario.ypos = 435;
    mario.vx = 0;
    mario.vy = 0;
    mario.direction = 1;
    mario.onFloor = 1;
    mario.ay = 0;
    mario.vy = 0;
    mario.floorNumber = 1;
    mario.previousFloor = 1;
    mario.onLadder = 0;
    mario.alive = 1;
    mario.hasHammer = 0;
    mario.hadHammer = 0;
    mario.hammerStartTime = 0;
    mario.jumping = 0;
    mario.currentState = 1;
    
    //Initialize DonkeyKong
    donkeykong.currentState = 3;
    donkeykong.currentFrame = 0;
    
    //Initialize Barrels
    barrels.clear();
}

void DonkeyKongGame::setBarrelSpeedBoost(){
    int i;
    for(i = 0; i < barrels.size(); i++){
        barrels[i].speedBoost = (level - 1) * 1;
    }
}
